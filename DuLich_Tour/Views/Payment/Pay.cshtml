@model DuLich_Tour.Models.ViewModels.PaymentViewModel
@{
    ViewBag.Title = "Thanh Toán";
    var datTour = ViewBag.DatTour as DuLich_Tour.Models.DatTour;
    var stripePublishableKey = ViewBag.StripePublishableKey as string ?? "";
}

@section Styles {
    <style>
        /* Stripe Elements styling */
        #card-element {
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            background-color: #fff;
            min-height: 40px;
        }
        
        .StripeElement {
            height: 40px;
            padding: 10px 12px;
            color: #32325d;
            background-color: white;
            border: 1px solid transparent;
            border-radius: 4px;
            box-shadow: 0 1px 3px 0 #e6ebf1;
            transition: box-shadow 150ms ease;
        }
        
        .StripeElement--focus {
            box-shadow: 0 1px 3px 0 #cfd7df;
        }
        
        .StripeElement--invalid {
            border-color: #fa755a;
        }
        
        .StripeElement--webkit-autofill {
            background-color: #fefde5 !important;
        }
    </style>
}

<div class="container py-5">
    <h2 class="mb-4"><i class="fas fa-credit-card me-2"></i>Thanh Toán</h2>

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show">
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="row">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Thông tin đặt tour</h5>
                </div>
                <div class="card-body">
                    @if (datTour != null)
                    {
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>Mã đặt tour:</strong> #@datTour.IdDatTour
                            </div>
                            <div class="col-md-6">
                                <strong>Ngày đặt:</strong> @datTour.NgayDat.ToString("dd/MM/yyyy HH:mm")
                            </div>
                        </div>
                        if (datTour.TourDuLich != null)
                        {
                            <div class="mb-3">
                                <strong>Tour:</strong> @datTour.TourDuLich.TenTour
                            </div>
                        }
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>Số người lớn:</strong> @datTour.SoNguoiLon
                            </div>
                            <div class="col-md-6">
                                <strong>Số trẻ em:</strong> @datTour.SoTreEm
                            </div>
                        </div>
                        <div class="mb-3">
                            <strong>Tổng tiền:</strong>
                            <span class="text-success fs-4">@string.Format("{0:N0}₫", datTour.TongTien)</span>
                        </div>
                    }
                </div>
            </div>

            <div class="card border-0 shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Chọn phương thức thanh toán</h5>
                </div>
                <div class="card-body">
                    <!-- Chọn phương thức thanh toán -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Phương thức thanh toán</label>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-check payment-method-option" data-method="stripe">
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="paymentStripe" value="stripe" checked>
                                    <label class="form-check-label w-100 p-3 border rounded" for="paymentStripe" style="cursor: pointer;">
                                        <i class="fab fa-cc-stripe fa-2x text-primary mb-2"></i>
                                        <div class="fw-bold">Thẻ tín dụng/Ghi nợ</div>
                                        <small class="text-muted">Visa, Mastercard, Amex</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check payment-method-option" data-method="vnpay">
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="paymentVNPay" value="vnpay">
                                    <label class="form-check-label w-100 p-3 border rounded" for="paymentVNPay" style="cursor: pointer;">
                                        <i class="fas fa-wallet fa-2x text-success mb-2"></i>
                                        <div class="fw-bold">VNPay</div>
                                        <small class="text-muted">Thanh toán qua VNPay</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Form Stripe (hiển thị khi chọn Stripe) -->
                    <div id="stripe-payment-form" class="payment-form-section">
                        @if (string.IsNullOrEmpty(stripePublishableKey) || stripePublishableKey.Contains("YOUR_PUBLISHABLE_KEY"))
                        {
                            <div class="alert alert-warning">
                                <strong>Lưu ý:</strong> Stripe Publishable Key chưa được cấu hình. Vui lòng cập nhật trong Web.config.
                            </div>
                        }

                        <form id="payment-form">
                            @Html.AntiForgeryToken()
                            @Html.HiddenFor(m => m.BookingId)
                            @Html.HiddenFor(m => m.SoTien)

                            <!-- Stripe Elements sẽ được mount vào đây -->
                            <div class="mb-3">
                                <label class="form-label">Thông tin thẻ</label>
                                <div id="card-element" style="min-height: 40px;">
                                    <!-- Stripe Elements sẽ tạo form nhập thẻ ở đây -->
                                </div>
                                <div id="card-errors" role="alert" class="text-danger mt-2"></div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Tên chủ thẻ</label>
                                <input type="text" id="cardholder-name" class="form-control" placeholder="NGUYEN VAN A" required>
                            </div>

                            <button type="submit" id="submit-button" class="btn btn-primary w-100">
                                <span id="button-text">
                                    <i class="fas fa-lock me-2"></i>Thanh toán @string.Format("{0:N0}₫", Model.SoTien)
                                </span>
                                <span id="spinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
                            </button>
                        </form>
                    </div>

                    <!-- Form VNPay (hiển thị khi chọn VNPay) -->
                    <div id="vnpay-payment-form" class="payment-form-section" style="display: none;">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Bạn sẽ được chuyển đến trang thanh toán VNPay để hoàn tất giao dịch.
                        </div>
                        <form id="vnpay-form" action="@Url.Action("CreateVNPayPayment", "Payment")" method="POST">
                            @Html.AntiForgeryToken()
                            @Html.HiddenFor(m => m.BookingId)
                            @Html.HiddenFor(m => m.SoTien)
                            <button type="submit" class="btn btn-success w-100">
                                <i class="fas fa-wallet me-2"></i>Thanh toán qua VNPay
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card border-0 shadow-sm sticky-top" style="top: 100px;">
                <div class="card-body">
                    <h5 class="mb-4">Tóm tắt thanh toán</h5>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Số tiền:</span>
                            <strong>@string.Format("{0:N0}₫", Model.SoTien)</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Phí xử lý:</span>
                            <span class="text-muted">Miễn phí</span>
                        </div>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between mb-4">
                        <strong>Tổng cộng:</strong>
                        <strong class="text-success fs-4">@string.Format("{0:N0}₫", Model.SoTien)</strong>
                    </div>

                    <div class="alert alert-warning">
                        <small>
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Lưu ý về Test Mode:</strong><br>
                            Hiện tại hệ thống đang ở chế độ <strong>Test Mode (Sandbox)</strong> của Stripe.<br>
                            <br>
                            <strong>Trong Test Mode:</strong><br>
                            • Bạn <strong>KHÔNG THỂ</strong> dùng thẻ thật (thẻ Visa/Mastercard thật của bạn)<br>
                            • Phải dùng <strong>thẻ test</strong> do Stripe cung cấp để test<br>
                            • Không có tiền thật bị trừ<br>
                            <br>
                            <strong>Thẻ test để thử nghiệm:</strong><br>
                            Số thẻ: <code>4242 4242 4242 4242</code><br>
                            Ngày hết hạn: Bất kỳ ngày tương lai (ví dụ: 12/25)<br>
                            CVC: Bất kỳ 3 chữ số (ví dụ: 123)<br>
                            ZIP: Bất kỳ 5 chữ số (ví dụ: 12345)<br>
                            <br>
                            <strong>Khi nào dùng thẻ thật?</strong><br>
                            Khi chuyển sang <strong>Live Mode</strong> (production), bạn mới có thể dùng thẻ thật. 
                            Lúc đó sẽ cần thay keys trong Web.config từ `pk_test_` sang `pk_live_`.
                        </small>
                    </div>

                    <a href="@Url.Action("Details", "Booking", new { id = Model.BookingId })" class="btn btn-outline-secondary w-100">
                        <i class="fas fa-arrow-left me-2"></i>Quay lại
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stripe.js -->
<script src="https://js.stripe.com/v3/"></script>

<script>
    // Render các giá trị từ server trước
    var serverBookingId = @Model.BookingId;
    var serverAmount = @Model.SoTien.ToString(System.Globalization.CultureInfo.InvariantCulture);
    var serverCreatePaymentIntentUrl = '@Url.Action("CreatePaymentIntent", "Payment")';
    var serverConfirmPaymentUrl = '@Url.Action("ConfirmPayment", "Payment")';
    var serverBookingDetailsUrl = '@Url.Action("Details", "Booking", new { id = Model.BookingId })';
    // Xử lý chuyển đổi phương thức thanh toán
    document.addEventListener('DOMContentLoaded', function() {
        var paymentMethods = document.querySelectorAll('input[name="paymentMethod"]');
        var stripeForm = document.getElementById('stripe-payment-form');
        var vnpayForm = document.getElementById('vnpay-payment-form');

        paymentMethods.forEach(function(radio) {
            radio.addEventListener('change', function() {
                if (this.value === 'stripe') {
                    stripeForm.style.display = 'block';
                    vnpayForm.style.display = 'none';
                    // Mount Stripe card element nếu chưa mount
                    if (typeof cardElement !== 'undefined' && cardElement !== null) {
                        setTimeout(function() {
                            try {
                                var cardElementDiv = document.getElementById('card-element');
                                if (cardElementDiv) {
                                    // Unmount trước nếu đã mount
                                    try {
                                        cardElement.unmount();
                                    } catch(e) {
                                        // Ignore
                                    }
                                    // Mount lại
                                    cardElement.mount('#card-element');
                                    console.log('Stripe card element remounted');
                                }
                            } catch(e) {
                                console.error('Error mounting Stripe card:', e);
                            }
                        }, 100);
                    } else {
                        console.warn('Stripe cardElement chua duoc khoi tao. Kiem tra Stripe publishable key.');
                    }
                } else if (this.value === 'vnpay') {
                    stripeForm.style.display = 'none';
                    vnpayForm.style.display = 'block';
                    // Unmount Stripe card element khi chuyển sang VNPay
                    if (cardElement) {
                        try {
                            cardElement.unmount();
                        } catch(e) {
                            // Ignore if already unmounted
                        }
                    }
                }
            });
        });

        // Highlight option được chọn
        document.querySelectorAll('.payment-method-option').forEach(function(option) {
            option.addEventListener('click', function() {
                var radio = this.querySelector('input[type="radio"]');
                if (radio) {
                    radio.checked = true;
                    radio.dispatchEvent(new Event('change'));
                }
            });
        });
    });

    // Khởi tạo Stripe (chỉ khi có publishable key hợp lệ)
    var stripe = null;
    var cardElement = null;
    
    @if (!string.IsNullOrEmpty(stripePublishableKey) && !stripePublishableKey.Contains("YOUR_PUBLISHABLE_KEY"))
    {
        <text>
    try {
        console.log('Initializing Stripe with key:', '@Html.Raw(stripePublishableKey)'.substring(0, 20) + '...');
        stripe = Stripe('@Html.Raw(stripePublishableKey)');
        var elements = stripe.elements();

        // Tạo card element
        cardElement = elements.create('card', {
            style: {
                base: {
                    fontSize: '16px',
                    color: '#32325d',
                    fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                    '::placeholder': {
                        color: '#aab7c4',
                    },
                },
                invalid: {
                    color: '#fa755a',
                    iconColor: '#fa755a',
                },
            },
        });

        // Mount card element vào DOM ngay khi khởi tạo (Stripe là mặc định)
        function mountStripeCard() {
            var stripeForm = document.getElementById('stripe-payment-form');
            var cardElementDiv = document.getElementById('card-element');
            if (stripeForm && cardElementDiv && cardElement) {
                try {
                    // Kiểm tra xem đã mount chưa
                    if (cardElementDiv.children.length === 0) {
                        // Clear bất kỳ nội dung nào trong div trước khi mount
                        cardElementDiv.innerHTML = '';
                        cardElement.mount('#card-element');
                        console.log('Stripe card element mounted successfully');
                    } else {
                        console.log('Stripe card element already mounted');
                    }
                } catch(e) {
                    console.error('Error mounting Stripe card element:', e);
                    alert('Lỗi khởi tạo form nhập thẻ: ' + e.message);
                }
            } else {
                var missing = [];
                if (!stripeForm) missing.push('stripe-payment-form');
                if (!cardElementDiv) missing.push('card-element');
                if (!cardElement) missing.push('cardElement object');
                console.error('Cannot mount Stripe card. Missing:', missing.join(', '));
            }
        }
        
        // Mount ngay khi DOM ready - thử nhiều lần để đảm bảo
        function tryMountStripe() {
            if (cardElement) {
                mountStripeCard();
            } else {
                console.log('Waiting for Stripe to initialize...');
                setTimeout(tryMountStripe, 100);
            }
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(tryMountStripe, 200);
            });
        } else {
            setTimeout(tryMountStripe, 200);
        }

        // Xử lý lỗi real-time - chỉ gọi sau khi cardElement đã được tạo thành công
        if (cardElement) {
            cardElement.on('change', function(event) {
                var displayError = document.getElementById('card-errors');
                if (event.error) {
                    displayError.textContent = event.error.message;
                } else {
                    displayError.textContent = '';
                }
            });
        }
    } catch(e) {
        console.error('Error initializing Stripe:', e);
        alert('Lỗi khởi tạo Stripe: ' + e.message);
    }
    </text>
    }
    else
    {
        <text>
    console.error('Stripe Publishable Key chua duoc cau hinh hoac khong hop le');
    </text>
    }

    // Xử lý submit form Stripe
    var form = document.getElementById('payment-form');
    if (form) {
        // Chỉ xử lý Stripe nếu đã khởi tạo
        var isStripeReady = (typeof stripe !== 'undefined' && stripe !== null && typeof cardElement !== 'undefined' && cardElement !== null);
        
        if (isStripeReady) {
        var submitButton = document.getElementById('submit-button');
        var buttonText = document.getElementById('button-text');
        var spinner = document.getElementById('spinner');

        form.addEventListener('submit', async function(event) {
            event.preventDefault();

            // Disable button
            submitButton.disabled = true;
            buttonText.classList.add('d-none');
            spinner.classList.remove('d-none');

            var cardholderName = document.getElementById('cardholder-name').value;
            var bookingId = serverBookingId;
            var amount = serverAmount;

            try {
                console.log('Starting payment process...');
                
                // Bước 1: Tạo Payment Intent từ server
                console.log('Calling CreatePaymentIntent API...');
                var response = await fetch(serverCreatePaymentIntentUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    body: JSON.stringify({
                        bookingId: bookingId,
                        amount: amount
                    })
                });

                var data = await response.json();
                console.log('CreatePaymentIntent response:', data);

                if (!data.success) {
                    throw new Error(data.message || 'Không thể tạo payment intent');
                }

                if (!data.clientSecret) {
                    throw new Error('Không nhận được clientSecret từ server');
                }

                console.log('Payment Intent created, confirming with Stripe...');

                // Bước 2: Xác nhận thanh toán với Stripe
                var result = await stripe.confirmCardPayment(data.clientSecret, {
                    payment_method: {
                        card: cardElement,
                        billing_details: {
                            name: cardholderName,
                        },
                    }
                });

                console.log('Stripe confirmCardPayment result:', result);

                if (result.error) {
                    // Hiển thị lỗi
                    console.error('Stripe payment error:', result.error);
                    var errorElement = document.getElementById('card-errors');
                    errorElement.textContent = result.error.message;
                    submitButton.disabled = false;
                    buttonText.classList.remove('d-none');
                    spinner.classList.add('d-none');
                } else {
                    // Thanh toán thành công, xác nhận với server
                    console.log('Payment succeeded, confirming with server...');
                    console.log('Payment Intent ID:', result.paymentIntent.id);
                    
                    var confirmResponse = await fetch(serverConfirmPaymentUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                        },
                        body: JSON.stringify({
                            bookingId: bookingId,
                            paymentIntentId: result.paymentIntent.id,
                            paymentMethodId: result.paymentIntent.payment_method
                        })
                    });

                    var confirmData = await confirmResponse.json();
                    console.log('ConfirmPayment response:', confirmData);

                    if (confirmData.success) {
                        console.log('Payment confirmed successfully, redirecting...');
                        // Chuyển hướng đến trang chi tiết đặt tour
                        window.location.href = confirmData.redirectUrl || serverBookingDetailsUrl;
                    } else {
                        throw new Error(confirmData.message || 'Xác nhận thanh toán thất bại');
                    }
                }
            } catch (error) {
                var errorElement = document.getElementById('card-errors');
                errorElement.textContent = error.message || 'Đã xảy ra lỗi khi xử lý thanh toán';
                submitButton.disabled = false;
                buttonText.classList.remove('d-none');
                spinner.classList.add('d-none');
            }
        });
        } else {
            console.warn('Stripe chua duoc khoi tao. Chi co the thanh toan bang VNPay.');
        }
    }
    </text>
    }
</script>

